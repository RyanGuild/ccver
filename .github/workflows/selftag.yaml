name: Auto Tag

on:
  push: {}
  workflow_dispatch: {}

jobs:
  tag:
    name: Create Tag
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@nightly
    
    - name: Get Version
      id: get_version
      run: |
        # Build and run the project to get the version
        cargo build --quiet
        VERSION=$(cargo run | tr -d '\n')
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
    
    - name: Create and Push Tag
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        
        # Check if tag already exists
        if ! git rev-parse "v$VERSION" >/dev/null 2>&1; then
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          echo "Creating new tag $VERSION"
          git tag -a "$VERSION" -m "Create version $VERSION"
          git push origin "$VERSION"
        else
          echo "Tag $VERSION already exists, skipping"
        fi
